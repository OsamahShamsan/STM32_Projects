#include "vt100.h"
#include "uart_dma.h"
#include <string.h>
#include <stdio.h>
#include <stdarg.h>

static void vt100_send(const char* str) {
    uart_dma_send((const uint8_t*)str, strlen(str));
}

static void vt100_send_char(char c) {
    uart_dma_send((const uint8_t*)&c, 1);
}

void vt100_write_SRAM_text(const char* str) {
    vt100_send(str);
}

void vt100_write_SRAM_line(const char* str) {
    vt100_send(str);
    vt100_send("\r\n");
}

void vt100_write_char(char c) {
    vt100_send_char(c);
}

void vt100_printf(const char* fmt, ...) {
    char buffer[64];
    va_list args;
    va_start(args, fmt);
    vsnprintf(buffer, sizeof(buffer), fmt, args);
    va_end(args);
    vt100_send(buffer);
}

void vt100_write_number(int16_t n, uint8_t width, char fill) {
    char buffer[16];
    snprintf(buffer, sizeof(buffer), "%*c%d", width - snprintf(NULL, 0, "%d", n), fill, n);

    // Simpler and safer pattern using format string creation:
    char format[8];
    snprintf(format, sizeof(format), "%%%c%dd", fill, width);
    snprintf(buffer, sizeof(buffer), format, n);

    vt100_send(buffer);
}

// VT100 controls
void vt100_goto(uint8_t row, uint8_t col) {
    char cmd[32];
    snprintf(cmd, sizeof(cmd), "\033[%d;%dH", row, col);
    vt100_send(cmd);
}

void vt100_goto_line(uint8_t line) {
    vt100_goto(line, 1);
}

void vt100_clear_screen(void) {
    vt100_send("\033[2J");
    vt100_send("\033[H");
}

void vt100_clear_line(void) {
    vt100_send("\033[2K");
}

void vt100_cursor_hide(void) {
    vt100_send("\033[?25l");
}

void vt100_cursor_show(void) {
    vt100_send("\033[?25h");
}

void vt100_set_color(const char* attr) {
    if (attr) vt100_send(attr);
}

void vt100_reset_color(void) {
    vt100_send("\033[0m");
}

// RX buffering
static uint8_t rx_buffer[UART_RX_BUFFER_SIZE];
static uint16_t rx_head = 0;
static uint16_t rx_tail = 0;

void vt100_process_rx_chunk(void) {
    uint16_t new_bytes;
    const uint8_t* data = uart_dma_get_new_bytes(&new_bytes);

    for (uint16_t i = 0; i < new_bytes; i++) {
        rx_buffer[rx_head++] = data[i];
        if (rx_head >= UART_RX_BUFFER_SIZE) rx_head = 0;
    }
}

uint8_t vt100_char_available(void) {
    return rx_head != rx_tail;
}

uint8_t vt100_read_char(void) {
    if (rx_head == rx_tail) return 0;
    uint8_t c = rx_buffer[rx_tail++];
    if (rx_tail >= UART_RX_BUFFER_SIZE) rx_tail = 0;
    return c;
}
