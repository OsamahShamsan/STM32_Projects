#include "menu.h"
#include "vt100.h"
#include <string.h>

//#define MENU_TOTAL_LINES 5
//#define MENU_LINE_SPACER 2

static const char* intro_lines[] = {
    "-------------------------",
    "  Welcome to the System!",
    "  Select an option below:",
    "-------------------------"
};

static const char* instructions =
    VT100_BOLD "Use ↑ ↓ to navigate. Press Enter to select." VT100_RESET;

static const char* menu_lines[MENU_TOTAL_LINES] = {
    "Option 1 - Sensor Config",
    "Option 2 - Motor Control",
    "Option 3 - System Info",
    "Option 4 - LCD Settings",
    "Option 5 - Exit"
};

#define NUM_INTRO_LINES (sizeof(intro_lines) / sizeof(intro_lines[0]))
#define NUM_INSTRUCTION_LINES  1
#define MENU_TOP_OFFSET (NUM_INTRO_LINES + NUM_INSTRUCTION_LINES + MENU_LINE_SPACER)

static int selected_index = 0;

void Menu_Init(void) {
    vt100_clear_screen();
    vt100_goto_line(1);
    Menu_Display();
}

void Menu_Display(void) {
    vt100_cursor_hide();
    vt100_goto_line(1);

    for (size_t i = 0; i < NUM_INTRO_LINES; i++) {
        vt100_print_line(intro_lines[i]);
    }

    vt100_print_line("");  // Spacer
    vt100_print_line(instructions);

    for (int i = 0; i < MENU_TOTAL_LINES; i++) {
        Menu_UpdateLine(i, i == selected_index);
    }

    vt100_cursor_show();
}

void Menu_UpdateLine(int index, int is_selected) {
    vt100_goto_line(MENU_TOP_OFFSET + index);
    vt100_clear_line();
    vt100_send(is_selected ? "> " : "  ");
    vt100_send(menu_lines[index]);
}

void Menu_ExecuteSelected(int index) {
    vt100_print_line("");
    vt100_set_color(VT100_GREEN);
    vt100_print_line(menu_lines[index]);
    vt100_reset_color();
}

void Menu_HandleInput(uint8_t input) {
    static enum { ESC_NONE, ESC_ESC, ESC_BRACKET } esc_state = ESC_NONE;
    int old_index = selected_index;

    switch (esc_state) {
        case ESC_NONE:
            if (input == 0x1B) esc_state = ESC_ESC;
            else if (input == '\r') Menu_ExecuteSelected(selected_index);
            break;
        case ESC_ESC:
            if (input == '[') esc_state = ESC_BRACKET;
            else esc_state = ESC_NONE;
            break;
        case ESC_BRACKET:
            if (input == 'A') selected_index = (selected_index == 0) ? MENU_TOTAL_LINES - 1 : selected_index - 1;
            else if (input == 'B') selected_index = (selected_index + 1) % MENU_TOTAL_LINES;

            if (old_index != selected_index) {
                Menu_UpdateLine(old_index, 0);
                Menu_UpdateLine(selected_index, 1);
            }
            esc_state = ESC_NONE;
            break;
        default:
            esc_state = ESC_NONE;
            break;
    }
}
