#include "uart_dma.h"
#include "menu.h"

extern UART_HandleTypeDef huart2;

static uint8_t rx_buffer[UART_RX_BUFFER_SIZE];
static volatile uint16_t last_pos = 0;

void uart_dma_send(uint8_t* data, uint16_t size) {
    while (huart2.gState != HAL_UART_STATE_READY);
    HAL_UART_Transmit_DMA(&huart2, data, size);
}

void uart_dma_init_rx(void) {
    HAL_UART_Receive_DMA(&huart2, rx_buffer, UART_RX_BUFFER_SIZE);
    __HAL_DMA_ENABLE_IT(huart2.hdmarx, DMA_IT_HT); // optional: Half Transfer
    __HAL_DMA_ENABLE_IT(huart2.hdmarx, DMA_IT_TC); // optional: Transfer Complete
    __HAL_UART_CLEAR_IDLEFLAG(&huart2);
    __HAL_UART_ENABLE_IT(&huart2, UART_IT_IDLE);
}

void uart_dma_poll(void) {
    uint16_t pos = UART_RX_BUFFER_SIZE - __HAL_DMA_GET_COUNTER(huart2.hdmarx);

    while (last_pos != pos) {
        uint8_t byte = rx_buffer[last_pos++];
        if (last_pos >= UART_RX_BUFFER_SIZE) last_pos = 0;
        Menu_HandleInput(byte);
    }
}

